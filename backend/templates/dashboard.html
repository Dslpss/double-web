<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blaze Double Analyzer - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .status-bar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4caf50;
      }

      .status-dot.offline {
        background: #f44336;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .card h2 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.3rem;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        gap: 8px;
        margin-bottom: 20px;
      }

      .result-item {
        aspect-ratio: 1;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease;
      }

      .result-item:hover {
        transform: scale(1.05);
      }

      .result-item.red {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .result-item.black {
        background: linear-gradient(135deg, #2c3e50, #34495e);
      }

      .result-item.white {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .result-number {
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 0.6rem;
        opacity: 0.8;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .metric-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .metric-label {
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .input-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .input-group input,
      .input-group select {
        flex: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .alerts-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
      }

      .alert-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        color: white;
        font-weight: bold;
      }

      .alert-item.pending {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .alert-item.correct {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
      }

      .alert-item.incorrect {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #c62828;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .results-grid {
          grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸ”¥ Blaze Double Analyzer</h1>
        <p>Dashboard AvanÃ§ado - AnÃ¡lise de PadrÃµes em Tempo Real</p>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot" id="wsStatus"></div>
          <span>WebSocket: <span id="wsStatusText">Conectando...</span></span>
        </div>
        <div class="status-item">
          <div class="status-dot" id="analyzerStatus"></div>
          <span
            >Analyzer: <span id="analyzerStatusText">Carregando...</span></span
          >
        </div>
        <div class="status-item">
          <span>Resultados: <span id="resultsCount">0</span></span>
        </div>
        <div class="status-item">
          <span>PrecisÃ£o: <span id="accuracyRate">0%</span></span>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="totalResults">0</div>
          <div class="metric-label">Total de Resultados</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="correctPredictions">0</div>
          <div class="metric-label">PrediÃ§Ãµes Corretas</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="currentConfidence">0%</div>
          <div class="metric-label">ConfianÃ§a Atual</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="activePatterns">0</div>
          <div class="metric-label">PadrÃµes Ativos</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h2>ðŸ“Š Ãšltimos Resultados</h2>
          <div class="results-grid" id="resultsGrid">
            <div class="loading">Carregando resultados...</div>
          </div>
        </div>

        <div class="card">
          <h2>ðŸ“ˆ DistribuiÃ§Ã£o de Cores</h2>
          <div class="chart-container">
            <canvas id="colorChart"></canvas>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h2>ðŸ“Š TendÃªncia de NÃºmeros</h2>
          <div class="chart-container">
            <canvas id="numberChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h2>ðŸŽ¯ AnÃ¡lise de PadrÃµes</h2>
          <div id="analysisContent">
            <div class="loading">Carregando anÃ¡lise...</div>
          </div>
        </div>
      </div>

      <div class="input-section">
        <h2>âž• Adicionar Resultado Manual</h2>
        <div class="input-group">
          <input
            type="number"
            id="numberInput"
            placeholder="NÃºmero (0-14)"
            min="0"
            max="14"
          />
          <select id="colorInput">
            <option value="">Selecione a cor</option>
            <option value="red">ðŸ”´ Vermelho</option>
            <option value="black">âš« Preto</option>
            <option value="white">âšª Branco</option>
          </select>
          <button class="btn" onclick="addManualResult()">Adicionar</button>
        </div>
      </div>

      <div class="alerts-section">
        <h2>ðŸš¨ Alertas e ValidaÃ§Ãµes</h2>
        <div id="alertsContent">
          <div class="loading">Carregando alertas...</div>
        </div>
      </div>
    </div>

    <script>
      // Conectar ao WebSocket
      const socket = io();

      // Elementos DOM
      const wsStatus = document.getElementById("wsStatus");
      const wsStatusText = document.getElementById("wsStatusText");
      const analyzerStatus = document.getElementById("analyzerStatus");
      const analyzerStatusText = document.getElementById("analyzerStatusText");
      const resultsCount = document.getElementById("resultsCount");
      const accuracyRate = document.getElementById("accuracyRate");
      const totalResults = document.getElementById("totalResults");
      const correctPredictions = document.getElementById("correctPredictions");
      const currentConfidence = document.getElementById("currentConfidence");
      const activePatterns = document.getElementById("activePatterns");
      const resultsGrid = document.getElementById("resultsGrid");
      const analysisContent = document.getElementById("analysisContent");
      const alertsContent = document.getElementById("alertsContent");

      // Estado da aplicaÃ§Ã£o
      let results = [];
      let analysis = {};
      let alerts = [];

      // GrÃ¡ficos
      let colorChart = null;
      let numberChart = null;

      // Eventos do WebSocket
      socket.on("connect", () => {
        console.log("Conectado ao servidor");
        updateStatus("ws", true, "Conectado");
      });

      socket.on("disconnect", () => {
        console.log("Desconectado do servidor");
        updateStatus("ws", false, "Desconectado");
      });

      socket.on("new_result", (data) => {
        console.log("Novo resultado:", data);
        addResult(data);
      });

      socket.on("analysis_update", (data) => {
        console.log("AnÃ¡lise atualizada:", data);
        updateAnalysis(data);
      });

      socket.on("results_update", (data) => {
        console.log("Resultados atualizados:", data);
        updateResults(data.results);
      });

      socket.on("error", (data) => {
        console.error("Erro:", data.message);
        showError(data.message);
      });

      // FunÃ§Ãµes de atualizaÃ§Ã£o
      function updateStatus(type, connected, text) {
        if (type === "ws") {
          wsStatus.className = `status-dot ${connected ? "" : "offline"}`;
          wsStatusText.textContent = text;
        } else if (type === "analyzer") {
          analyzerStatus.className = `status-dot ${connected ? "" : "offline"}`;
          analyzerStatusText.textContent = text;
        }
      }

      function addResult(data) {
        results.unshift(data);
        if (results.length > 100) {
          results = results.slice(0, 100);
        }
        updateResultsGrid();
        updateMetrics();
        updateCharts();
      }

      function updateResults(newResults) {
        results = newResults || [];
        updateResultsGrid();
        updateMetrics();
        updateCharts();
      }

      function updateResultsGrid() {
        if (results.length === 0) {
          resultsGrid.innerHTML =
            '<div class="loading">Nenhum resultado disponÃ­vel</div>';
          return;
        }

        resultsGrid.innerHTML = results
          .slice(0, 50)
          .map(
            (result) => `
                <div class="result-item ${result.color}">
                    <div class="result-number">${result.number}</div>
                    ${
                      result.color === "red"
                        ? "ðŸ”´"
                        : result.color === "black"
                        ? "âš«"
                        : "âšª"
                    }
                </div>
            `
          )
          .join("");
      }

      function updateMetrics() {
        resultsCount.textContent = results.length;
        totalResults.textContent = results.length;

        // Calcular mÃ©tricas bÃ¡sicas
        const colorCounts = results.reduce((acc, result) => {
          acc[result.color] = (acc[result.color] || 0) + 1;
          return acc;
        }, {});

        const total = results.length;
        const redCount = colorCounts.red || 0;
        const blackCount = colorCounts.black || 0;
        const whiteCount = colorCounts.white || 0;

        // Simular precisÃ£o (substituir por dados reais)
        const simulatedAccuracy = Math.min(85, 60 + Math.random() * 25);
        accuracyRate.textContent = `${simulatedAccuracy.toFixed(1)}%`;

        // Simular prediÃ§Ãµes corretas
        const simulatedCorrect = Math.floor((total * simulatedAccuracy) / 100);
        correctPredictions.textContent = simulatedCorrect;

        // Simular confianÃ§a atual
        const simulatedConfidence = Math.min(95, 70 + Math.random() * 25);
        currentConfidence.textContent = `${simulatedConfidence.toFixed(1)}%`;

        // Simular padrÃµes ativos
        const simulatedPatterns = Math.floor(Math.random() * 5) + 1;
        activePatterns.textContent = simulatedPatterns;
      }

      function updateCharts() {
        updateColorChart();
        updateNumberChart();
      }

      function updateColorChart() {
        const ctx = document.getElementById("colorChart").getContext("2d");

        if (colorChart) {
          colorChart.destroy();
        }

        const colorCounts = results.reduce((acc, result) => {
          acc[result.color] = (acc[result.color] || 0) + 1;
          return acc;
        }, {});

        colorChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Vermelho", "Preto", "Branco"],
            datasets: [
              {
                data: [
                  colorCounts.red || 0,
                  colorCounts.black || 0,
                  colorCounts.white || 0,
                ],
                backgroundColor: ["#e74c3c", "#2c3e50", "#f39c12"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function updateNumberChart() {
        const ctx = document.getElementById("numberChart").getContext("2d");

        if (numberChart) {
          numberChart.destroy();
        }

        const numberCounts = results.reduce((acc, result) => {
          acc[result.number] = (acc[result.number] || 0) + 1;
          return acc;
        }, {});

        const numbers = Array.from({ length: 15 }, (_, i) => i);
        const counts = numbers.map((num) => numberCounts[num] || 0);

        numberChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: numbers,
            datasets: [
              {
                label: "FrequÃªncia",
                data: counts,
                backgroundColor: "rgba(102, 126, 234, 0.6)",
                borderColor: "rgba(102, 126, 234, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function updateAnalysis(data) {
        analysis = data;

        if (!data || !data.predictions) {
          analysisContent.innerHTML =
            '<div class="loading">Nenhuma anÃ¡lise disponÃ­vel</div>';
          return;
        }

        const pred = data.predictions;
        analysisContent.innerHTML = `
                <div class="analysis-section">
                    <h3>ðŸŽ¯ PrediÃ§Ã£o Atual</h3>
                    <div class="analysis-item">
                        <div class="color-label">
                            <div class="color-dot ${
                              pred.recommended_color
                            }"></div>
                            <span>${
                              pred.recommended_color?.toUpperCase() || "N/A"
                            }</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${
                              (pred.confidence || 0) * 100
                            }%"></div>
                        </div>
                        <span>${Math.round(
                          (pred.confidence || 0) * 100
                        )}%</span>
                    </div>
                </div>
            `;
      }

      function updateAlerts() {
        // Implementar atualizaÃ§Ã£o de alertas
        alertsContent.innerHTML =
          '<div class="loading">Carregando alertas...</div>';
      }

      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        document.body.insertBefore(errorDiv, document.body.firstChild);

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }

      function addManualResult() {
        const number = parseInt(document.getElementById("numberInput").value);
        const color = document.getElementById("colorInput").value;

        if (!number || !color) {
          showError("Por favor, preencha nÃºmero e cor");
          return;
        }

        if (number < 0 || number > 14) {
          showError("NÃºmero deve estar entre 0 e 14");
          return;
        }

        fetch("/api/add_result", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ number, color }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              addResult({ number, color, timestamp: Date.now() });
              document.getElementById("numberInput").value = "";
              document.getElementById("colorInput").value = "";
            } else {
              showError(data.error || "Erro ao adicionar resultado");
            }
          })
          .catch((error) => {
            showError("Erro de conexÃ£o: " + error.message);
          });
      }

      // Carregar dados iniciais
      function loadInitialData() {
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            updateStatus(
              "analyzer",
              data.analyzer_ready,
              data.analyzer_ready ? "Pronto" : "Erro"
            );
          });

        fetch("/api/results")
          .then((response) => response.json())
          .then((data) => {
            if (data.results) {
              updateResults(data.results);
            }
          });

        fetch("/api/analysis")
          .then((response) => response.json())
          .then((data) => {
            if (!data.error) {
              updateAnalysis(data);
            }
          });
      }

      // Inicializar aplicaÃ§Ã£o
      document.addEventListener("DOMContentLoaded", () => {
        loadInitialData();

        // Solicitar atualizaÃ§Ãµes via WebSocket
        socket.emit("request_analysis");
        socket.emit("request_results");
      });
    </script>
  </body>
</html>
