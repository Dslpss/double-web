<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Padrões Personalizados - Double Analyzer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .pattern-card {
        transition: transform 0.2s;
        border-left: 4px solid #007bff;
      }
      .pattern-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .pattern-card.enabled {
        border-left-color: #28a745;
      }
      .pattern-card.disabled {
        border-left-color: #dc3545;
        opacity: 0.7;
      }
      .trigger-badge {
        font-size: 0.8em;
      }
      .stats-badge {
        font-size: 0.75em;
      }
      .modal-lg {
        max-width: 800px;
      }
      .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
      }
      .form-section h6 {
        color: #495057;
        margin-bottom: 15px;
        font-weight: 600;
      }
      .config-preview {
        background-color: #fff;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px;
        font-family: monospace;
        font-size: 0.9em;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .action-buttons {
        gap: 5px;
      }
      .pattern-type-icon {
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 8px;
      }
      .success-rate {
        font-weight: bold;
      }
      .success-rate.high {
        color: #28a745;
      }
      .success-rate.medium {
        color: #ffc107;
      }
      .success-rate.low {
        color: #dc3545;
      }
      .alert {
        border-left: 4px solid;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      .alert-info {
        border-left-color: #17a2b8;
        background-color: #d1ecf1;
        color: #0c5460;
      }
      .alert-success {
        border-left-color: #28a745;
        background-color: #d4edda;
        color: #155724;
      }
      .alert-warning {
        border-left-color: #ffc107;
        background-color: #fff3cd;
        color: #856404;
      }
      .alert-light {
        border-left-color: #6c757d;
        background-color: #fefefe;
        color: #495057;
      }
      .form-range::-webkit-slider-thumb {
        background: #007bff;
      }
      .form-range::-moz-range-thumb {
        background: #007bff;
        border: none;
      }
      #confidenceValue {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
      }
      .tooltip-icon {
        cursor: help;
        color: #6c757d;
      }
      .tooltip-icon:hover {
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-dice"></i> Double Analyzer
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
          <a class="nav-link" href="/double"
            ><i class="fas fa-chart-line"></i> Double</a
          >
          <a class="nav-link active" href="#"
            ><i class="fas fa-cogs"></i> Padrões Personalizados</a
          >
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col">
          <h2><i class="fas fa-cogs"></i> Padrões Personalizados</h2>
          <p class="text-muted">
            Crie e gerencie seus próprios padrões de detecção para o Double
          </p>
        </div>
        <div class="col-auto">
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#createPatternModal"
          >
            <i class="fas fa-plus"></i> Novo Padrão
          </button>
          <button class="btn btn-outline-secondary" onclick="exportPatterns()">
            <i class="fas fa-download"></i> Exportar
          </button>
          <button
            class="btn btn-outline-secondary"
            onclick="document.getElementById('importFile').click()"
          >
            <i class="fas fa-upload"></i> Importar
          </button>
          <input
            type="file"
            id="importFile"
            accept=".json"
            style="display: none"
            onchange="importPatterns(this)"
          />
        </div>
      </div>

      <!-- Alert Type Control Panel -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h6 class="card-title mb-1">
                    <i class="fas fa-bell"></i> Configuração de Alertas
                  </h6>
                  <small class="text-muted">Escolha que tipo de alertas você deseja receber</small>
                </div>
                <div class="col-md-6">
                  <div class="d-flex gap-3 justify-content-md-end">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="enableSystemAlerts" checked>
                      <label class="form-check-label" for="enableSystemAlerts">
                        <i class="fas fa-robot text-primary"></i> Alertas do Sistema
                      </label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="enableCustomAlerts" checked>
                      <label class="form-check-label" for="enableCustomAlerts">
                        <i class="fas fa-user-cog text-success"></i> Padrões Customizados
                      </label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="testAlerts()" title="Testar alertas">
                      <i class="fas fa-vial"></i> Testar
                    </button>
                  </div>
                </div>
              </div>
              <div class="row mt-3" id="alertStatusDisplay">
                <div class="col-12">
                  <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="alertStatusText">Ambos os tipos de alertas estão ativos</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
          >
            <i class="fas fa-upload"></i> Importar
          </button>
          <input
            type="file"
            id="importFile"
            accept=".json"
            style="display: none"
            onchange="importPatterns(this)"
          />
        </div>
      </div>

      <!-- Status Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">Total de Padrões</h6>
                  <h3 id="totalPatterns">0</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-cogs fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">Padrões Ativos</h6>
                  <h3 id="activePatterns">0</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-check-circle fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">Taxa de Sucesso</h6>
                  <h3 id="successRate">0%</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-chart-line fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">Total de Triggers</h6>
                  <h3 id="totalTriggers">0</h3>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-bolt fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Patterns List -->
      <div class="row" id="patternsList">
        <!-- Patterns will be loaded here -->
      </div>

      <!-- Loading -->
      <div id="loading" class="text-center mt-4" style="display: none">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2">Carregando padrões...</p>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="text-center mt-5" style="display: none">
        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Nenhum padrão personalizado encontrado</h4>
        <p class="text-muted">
          Crie seu primeiro padrão personalizado para começar a detectar padrões
          específicos.
        </p>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#createPatternModal"
        >
          <i class="fas fa-plus"></i> Criar Primeiro Padrão
        </button>
      </div>
    </div>

    <!-- Create/Edit Pattern Modal -->
    <div class="modal fade" id="createPatternModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Criar Novo Padrão</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Seção de Ajuda e Orientações -->
            <div class="alert alert-primary alert-dismissible fade show" role="alert">
              <div class="d-flex">
                <i class="fas fa-lightbulb me-2 mt-1"></i>
                <div class="flex-grow-1">
                  <strong>💡 Como funcionam os Padrões Personalizados:</strong>
                  <p class="mb-2">Configure <strong>gatilhos</strong> (quando detectar) e <strong>ações</strong> (o que fazer) para automatizar sua estratégia.</p>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#quickHelp">
                    <i class="fas fa-question-circle"></i> Ver Guia Rápido
                  </button>
                </div>
              </div>
              
              <div class="collapse mt-3" id="quickHelp">
                <div class="row small">
                  <div class="col-md-6">
                    <div class="border-start border-success border-3 ps-3 mb-3">
                      <h6 class="text-success mb-2">
                        <i class="fas fa-play-circle"></i> Gatilhos Populares
                      </h6>
                      <ul class="list-unstyled mb-0">
                        <li><span class="badge bg-info me-1">🎯</span> <strong>Cor após cor:</strong> Ex: "Red após Black"</li>
                        <li><span class="badge bg-info me-1">📊</span> <strong>Número + cor:</strong> Ex: "7 seguido de Red"</li>
                        <li><span class="badge bg-info me-1">⏰</span> <strong>Delay:</strong> Ex: "Número 5 não sai há 8 rodadas"</li>
                      </ul>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="border-start border-warning border-3 ps-3 mb-3">
                      <h6 class="text-warning mb-2">
                        <i class="fas fa-cogs"></i> Ações Recomendadas
                      </h6>
                      <ul class="list-unstyled mb-0">
                        <li><span class="badge bg-success me-1">🎲</span> <strong>Apostar cor:</strong> Red, Black ou White</li>
                        <li><span class="badge bg-success me-1">🎯</span> <strong>Apostar número:</strong> Específico (0-14)</li>
                        <li><span class="badge bg-success me-1">⏸️</span> <strong>Aguardar:</strong> Pular esta rodada</li>
                      </ul>
                    </div>
                  </div>
                </div>
                
                <div class="bg-light p-2 rounded mt-2">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    <strong>Dica de Confiança:</strong> Use 60-80% para padrões equilibrados. Muito alto = poucas oportunidades, muito baixo = muitos alertas.
                  </small>
                </div>
              </div>
            </div>

            <form id="patternForm">
              <input type="hidden" id="patternId" />

              <!-- Basic Info -->
              <div class="form-section">
                <h6><i class="fas fa-info-circle"></i> Informações Básicas</h6>
                <div class="row">
                  <div class="col-md-6">
                    <label for="patternName" class="form-label"
                      >Nome do Padrão *</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="patternName"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="patternEnabled" class="form-label"
                      >Status</label
                    >
                    <select class="form-select" id="patternEnabled">
                      <option value="true">Ativo</option>
                      <option value="false">Inativo</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <label for="patternDescription" class="form-label"
                      >Descrição</label
                    >
                    <textarea
                      class="form-control"
                      id="patternDescription"
                      rows="2"
                    ></textarea>
                  </div>
                </div>
              </div>

              <!-- Trigger Configuration -->
              <div class="form-section">
                <h6><i class="fas fa-bolt text-primary"></i> Configuração do Gatilho</h6>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <strong>Gatilhos</strong> definem <em>quando</em> o padrão será ativado. Escolha o tipo que melhor se adapta à sua estratégia de análise.
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label for="triggerType" class="form-label"
                      >Tipo de Gatilho *
                      <i class="fas fa-question-circle text-info" 
                         data-bs-toggle="tooltip" 
                         title="Selecione quando você quer que o sistema detecte e alerte sobre padrões"></i>
                    </label>
                    <select
                      class="form-select"
                      id="triggerType"
                      required
                      onchange="updateTriggerConfig()"
                    >
                      <option value="">Selecione um tipo</option>
                      <option value="number_followed_by_color" 
                              data-description="Detecta quando um número específico é seguido por uma cor específica"
                              data-example="Ex: Número 5 seguido pela cor VERMELHA">
                        📊 Número Seguido por Cor
                      </option>
                      <option value="color_sequence" 
                              data-description="Detecta sequências específicas de 2 cores consecutivas"
                              data-example="Ex: VERMELHO → PRETO → VERMELHO">
                        🌈 Sequência de Cores
                      </option>
                      <option value="color_after_color" 
                              data-description="Detecta quando uma cor específica aparece após outra cor"
                              data-example="Ex: VERMELHO sempre que vier após PRETO">
                        🎯 Cor Após Cor
                      </option>
                      <option value="specific_number_red" 
                              data-description="Monitora números vermelhos específicos (1,3,5,7,9,12,14)"
                              data-example="Ex: Quando sair o número 7 (vermelho)">
                        🔴 Número Vermelho Específico
                      </option>
                      <option value="specific_number_black" 
                              data-description="Monitora números pretos específicos (2,4,6,8,10,11,13)"
                              data-example="Ex: Quando sair o número 8 (preto)">
                        ⚫ Número Preto Específico
                      </option>
                      <option value="specific_number_white" 
                              data-description="Monitora quando sai o número 0 (branco)"
                              data-example="Ex: Quando sair o 0 (branco)">
                        ⚪ Número Branco (0)
                      </option>
                      <option value="red_after_black" 
                              data-description="Detecta quando VERMELHO aparece logo após PRETO"
                              data-example="Ex: PRETO → VERMELHO">
                        🔴⚫ Vermelho Após Preto
                      </option>
                      <option value="black_after_red" 
                              data-description="Detecta quando PRETO aparece logo após VERMELHO"
                              data-example="Ex: VERMELHO → PRETO">
                        ⚫🔴 Preto Após Vermelho
                      </option>
                      <option value="white_after_any" 
                              data-description="Detecta quando BRANCO (0) aparece após qualquer cor"
                              data-example="Ex: Qualquer cor → BRANCO (0)">
                        ⚪ Branco Após Qualquer
                      </option>
                      <option value="number_delay_alert" 
                              data-description="Alerta quando um número não sai há X resultados"
                              data-example="Ex: Número 5 não sai há 10 rodadas">
                        ⏰ Delay de Número (Alerta)
                      </option>
                    </select>
                    <div class="mt-2">
                      <small id="triggerTypeHelp" class="text-muted">
                        <i class="fas fa-arrow-up"></i> Selecione um tipo para ver a explicação e exemplo
                      </small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="minOccurrences" class="form-label"
                      >Ocorrências Mínimas
                      <i class="fas fa-question-circle text-info" 
                         data-bs-toggle="tooltip" 
                         title="Quantas vezes o padrão deve ocorrer consecutivamente antes de ativar o alerta"></i>
                    </label>
                    <input
                      type="number"
                      class="form-control"
                      id="minOccurrences"
                      min="1"
                      max="10"
                      value="1"
                    />
                    <small class="text-muted">
                      <i class="fas fa-lightbulb text-warning"></i> 
                      <strong>Recomendado:</strong> 1-3 para iniciantes, 3-5 para conservadores
                    </small>
                  </div>
                </div>
                <div id="triggerConfigArea" class="mt-3" style="display: none">
                  <!-- Dynamic trigger config will be inserted here -->
                </div>
              </div>

              <!-- Action Configuration -->
              <div class="form-section">
                <h6><i class="fas fa-play text-success"></i> Configuração da Ação</h6>
                <div class="alert alert-success">
                  <i class="fas fa-target"></i>
                  <strong>Ações</strong> definem <em>o que fazer</em> quando o gatilho for detectado. Configure a recomendação que será mostrada.
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label for="actionType" class="form-label"
                      >Tipo de Ação *
                      <i class="fas fa-question-circle text-info" 
                         data-bs-toggle="tooltip" 
                         title="Escolha que tipo de recomendação será mostrada quando o padrão for detectado"></i>
                    </label>
                    <select
                      class="form-select"
                      id="actionType"
                      required
                      onchange="updateActionConfig()"
                    >
                      <option value="">Selecione uma ação</option>
                      <option value="bet_color" 
                              data-description="Recomenda apostar em uma cor específica"
                              data-example="Ex: 'Aposte no VERMELHO' ou 'Aposte no PRETO'">
                        🎨 Apostar em Cor
                      </option>
                      <option value="bet_number" 
                              data-description="Recomenda apostar em um número específico"
                              data-example="Ex: 'Aposte no número 7' ou 'Aposte no número 0'">
                        🎯 Apostar em Número
                      </option>
                      <option value="skip_bet" 
                              data-description="Recomenda não apostar nesta rodada"
                              data-example="Ex: 'Pule esta rodada - aguarde melhor oportunidade'">
                        ⏸️ Pular Aposta
                      </option>
                      <option value="wait" 
                              data-description="Recomenda aguardar e observar mais resultados"
                              data-example="Ex: 'Aguarde - padrão ainda se formando'">
                        ⏳ Aguardar
                      </option>
                    </select>
                    <div class="mt-2">
                      <small id="actionTypeHelp" class="text-muted">
                        <i class="fas fa-arrow-up"></i> Selecione uma ação para ver a explicação e exemplo
                      </small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="confidenceThreshold" class="form-label"
                      >Nível de Confiança 
                      <i class="fas fa-question-circle text-info" 
                         data-bs-toggle="tooltip" 
                         title="Porcentagem mínima de certeza para ativar o alerta. Recomendado: 60-80%"></i>
                      (<span id="confidenceValue">70%</span>)</label
                    >
                    <input
                      type="range"
                      class="form-range"
                      id="confidenceThreshold"
                      min="0.1"
                      max="1"
                      step="0.05"
                      value="0.7"
                      oninput="updateConfidenceValue()"
                    />
                    <div class="d-flex justify-content-between small text-muted">
                      <span>10% (Muito sensível)</span>
                      <span>100% (Muito rígido)</span>
                    </div>
                    <small class="text-muted">
                      <i class="fas fa-balance-scale text-info"></i> 
                      <strong>Sugestão:</strong> 60-70% para iniciantes, 75-85% para conservadores
                    </small>
                  </div>
                </div>
                <div id="actionConfigArea" class="mt-3">
                  <!-- Dynamic action config will be inserted here -->
                </div>
              </div>
                  <strong>Ações</strong> definem o que fazer quando o padrão for detectado. Esta é a sua estratégia de aposta.
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label for="actionType" class="form-label"
                      >Tipo de Ação *</label
                    >
                    <select
                      class="form-select"
                      id="actionType"
                      required
                      onchange="updateActionConfig()"
                    >
                      <option value="">Selecione uma ação</option>
                      <option value="bet_color" title="Apostar em uma cor específica (RED/BLACK/WHITE)">
                        🎨 Apostar na Cor
                      </option>
                      <option value="bet_number" title="Apostar em um número específico (0-14)">
                        🔢 Apostar no Número
                      </option>
                      <option value="bet_sector" title="Apostar em um setor (baixo/médio/alto)">
                        📊 Apostar no Setor
                      </option>
                      <option value="skip_bet" title="Não apostar nesta rodada">
                        ⏭️ Pular Aposta
                      </option>
                      <option value="wait" title="Aguardar próxima oportunidade">
                        ⏳ Aguardar
                      </option>
                    </select>
                    <small class="text-muted mt-1">
                      <span id="actionTypeHelp">Selecione uma ação para ver a explicação</span>
                    </small>
                  </div>
                  <div class="col-md-6">
                    <label for="actionConfig" class="form-label"
                      >Configuração da Ação</label
                    >
                    <div id="actionConfigArea">
                      <!-- Dynamic action config will be inserted here -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- Advanced Settings -->
              <div class="form-section">
                <h6><i class="fas fa-cog"></i> Configurações Avançadas</h6>
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Configurações Avançadas</strong> - Ajuste estes valores com cuidado. Valores muito baixos podem gerar muitos alertas falsos.
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label for="confidenceThreshold" class="form-label">
                      Limiar de Confiança
                      <i class="fas fa-question-circle" title="Quão confiante o sistema deve estar antes de alertar"></i>
                    </label>
                    <input
                      type="range"
                      class="form-range"
                      id="confidenceThreshold"
                      min="0.5"
                      max="1"
                      step="0.05"
                      value="0.7"
                      oninput="updateConfidenceValue()"
                    />
                    <div class="d-flex justify-content-between">
                      <small>50% (Menos rigoroso)</small>
                      <span id="confidenceValue" class="badge bg-primary">70%</span>
                      <small>100% (Muito rigoroso)</small>
                    </div>
                    <small class="text-muted">Recomendado: 60-80% para a maioria dos casos</small>
                  </div>
                  <div class="col-md-6">
                    <label for="cooldownMinutes" class="form-label">
                      Cooldown (minutos)
                      <i class="fas fa-question-circle" title="Tempo de espera entre alertas do mesmo padrão"></i>
                    </label>
                    <input
                      type="number"
                      class="form-control"
                      id="cooldownMinutes"
                      min="1"
                      max="60"
                      value="5"
                    />
                    <small class="text-muted">Evita spam de alertas. Recomendado: 3-10 minutos</small>
                  </div>
                </div>
              </div>

              <!-- Examples & Tips -->
              <div class="form-section">
                <h6><i class="fas fa-lightbulb"></i> Exemplos & Dicas</h6>
                <div id="patternExamples" class="row">
                  <div class="col-12">
                    <div class="alert alert-light">
                      <h6><i class="fas fa-graduation-cap"></i> Dicas para Iniciantes:</h6>
                      <ul class="mb-0">
                        <li><strong>Padrão Simples:</strong> "Cor Após Cor" - Ex: RED após BLACK com confiança 70%</li>
                        <li><strong>Padrão Numérico:</strong> "Número Seguido por Cor" - Ex: Número 1 seguido por RED</li>
                        <li><strong>Padrão de Delay:</strong> "Delay de Número" - Ex: Alertar quando número 5 não sai há 10 rodadas</li>
                        <li><strong>Configuração Inicial:</strong> Use confiança entre 60-70% e cooldown de 5 minutos</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Preview -->
              <div class="form-section">
                <h6><i class="fas fa-eye"></i> Pré-visualização do Padrão</h6>
                <div class="config-preview" id="configPreview">
                  <div class="text-center text-muted">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>Selecione um tipo de gatilho e ação para ver a pré-visualização do seu padrão</p>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="savePattern()"
            >
              <i class="fas fa-save"></i> Salvar Padrão
            </button>
          </div>
        </div>
      </div>

      <!-- Pattern Stats Modal -->
      <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Estatísticas do Padrão</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body" id="statsContent">
              <!-- Stats will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let patterns = [];
      let editingPattern = null;

      // Configurações de alertas
      let alertSettings = {
        systemAlerts: true,
        customAlerts: true
      };

      // Load patterns on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadPatterns();
        initializeAlertControls();
      });

      // Inicializar controles de alerta
      function initializeAlertControls() {
        const systemToggle = document.getElementById('enableSystemAlerts');
        const customToggle = document.getElementById('enableCustomAlerts');
        
        // Carregar configurações do servidor
        loadAlertSettingsFromServer();

        // Event listeners para os toggles
        systemToggle.addEventListener('change', function() {
          alertSettings.systemAlerts = this.checked;
          updateAlertSettings();
        });

        customToggle.addEventListener('change', function() {
          alertSettings.customAlerts = this.checked;
          updateAlertSettings();
        });
      }

      // Carregar configurações do servidor
      async function loadAlertSettingsFromServer() {
        try {
          console.log('Carregando configurações de alerta...');
          
          // Primeiro, verificar se há configurações no localStorage
          const localSettings = localStorage.getItem('alertSettings');
          let hasLocalSettings = false;
          
          if (localSettings) {
            try {
              const parsedLocal = JSON.parse(localSettings);
              alertSettings = parsedLocal;
              hasLocalSettings = true;
              console.log('Configurações locais encontradas:', alertSettings);
            } catch (e) {
              console.warn('Erro ao parsear configurações locais:', e);
            }
          }
          
          // Se temos configurações locais, usar elas e sincronizar com servidor
          if (hasLocalSettings) {
            console.log('Usando configurações locais e sincronizando com servidor...');
            await saveAlertSettingsToBackend();
          } else {
            // Se não há configurações locais, buscar do servidor
            console.log('Buscando configurações do servidor...');
            const response = await fetch('/api/alert-settings');
            if (response.ok) {
              const data = await response.json();
              if (data.success) {
                alertSettings = data.settings;
                console.log('Configurações do servidor carregadas:', alertSettings);
                // Salvar no localStorage para próxima vez
                localStorage.setItem('alertSettings', JSON.stringify(alertSettings));
              }
            }
          }
          
          // Atualizar UI
          document.getElementById('enableSystemAlerts').checked = alertSettings.systemAlerts;
          document.getElementById('enableCustomAlerts').checked = alertSettings.customAlerts;
          
          updateAlertStatus();
          console.log('UI atualizada com configurações:', alertSettings);
          
        } catch (error) {
          console.error('Erro ao carregar configurações:', error);
          // Em caso de erro, usar configurações padrão
          alertSettings = { systemAlerts: true, customAlerts: true };
          updateAlertStatus();
        }
      }

      // Atualizar configurações de alerta
      function updateAlertSettings() {
        console.log('Atualizando configurações:', alertSettings);
        
        // Salvar no localStorage IMEDIATAMENTE
        try {
          localStorage.setItem('alertSettings', JSON.stringify(alertSettings));
          console.log('✅ Configurações salvas no localStorage');
        } catch (error) {
          console.error('❌ Erro ao salvar no localStorage:', error);
        }
        
        // Atualizar status visual
        updateAlertStatus();
        
        // Enviar para o backend (async, não bloqueia)
        saveAlertSettingsToBackend().then(() => {
          console.log('Sincronização com servidor concluída');
        }).catch(error => {
          console.error('Erro na sincronização:', error);
        });
        
        // Mostrar notificação de sucesso
        showAlertSettingsNotification();
      }

      // Atualizar status visual dos alertas
      function updateAlertStatus() {
        const statusText = document.getElementById('alertStatusText');
        const statusDisplay = document.getElementById('alertStatusDisplay').querySelector('.alert');
        
        if (alertSettings.systemAlerts && alertSettings.customAlerts) {
          statusText.innerHTML = '<i class="fas fa-check-double text-success"></i> Ambos os tipos de alertas estão ativos';
          statusDisplay.className = 'alert alert-success d-flex align-items-center';
        } else if (alertSettings.systemAlerts && !alertSettings.customAlerts) {
          statusText.innerHTML = '<i class="fas fa-robot text-primary"></i> Apenas alertas do sistema estão ativos';
          statusDisplay.className = 'alert alert-info d-flex align-items-center';
        } else if (!alertSettings.systemAlerts && alertSettings.customAlerts) {
          statusText.innerHTML = '<i class="fas fa-user-cog text-warning"></i> Apenas padrões customizados estão ativos';
          statusDisplay.className = 'alert alert-warning d-flex align-items-center';
        } else {
          statusText.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Todos os alertas estão desabilitados';
          statusDisplay.className = 'alert alert-danger d-flex align-items-center';
        }

        // Atualizar badges visuais
        updateAlertBadges();
      }

      // Atualizar badges visuais dos tipos de alerta
      function updateAlertBadges() {
        const systemLabel = document.querySelector('label[for="enableSystemAlerts"]');
        const customLabel = document.querySelector('label[for="enableCustomAlerts"]');
        
        if (alertSettings.systemAlerts) {
          systemLabel.classList.remove('text-muted');
          systemLabel.classList.add('text-primary');
        } else {
          systemLabel.classList.remove('text-primary');
          systemLabel.classList.add('text-muted');
        }
        
        if (alertSettings.customAlerts) {
          customLabel.classList.remove('text-muted');
          customLabel.classList.add('text-success');
        } else {
          customLabel.classList.remove('text-success');
          customLabel.classList.add('text-muted');
        }
      }

      // Salvar configurações no backend
      async function saveAlertSettingsToBackend() {
        try {
          console.log('Salvando configurações no servidor:', alertSettings);
          
          const response = await fetch('/api/alert-settings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(alertSettings)
          });
          
          console.log('Resposta do servidor:', response.status);
          
          if (response.ok) {
            const data = await response.json();
            console.log('Configurações salvas no servidor:', data);
            if (data.success) {
              console.log('✅ Configurações sincronizadas com sucesso');
            }
          } else {
            console.warn('❌ Falha ao salvar no servidor:', response.status);
          }
        } catch (error) {
          console.error('❌ Erro ao salvar configurações:', error);
        }
      }

      // Mostrar notificação das configurações de alerta
      function showAlertSettingsNotification() {
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
          <i class="fas fa-check-circle"></i> Configurações de alerta atualizadas!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }

      // Função para verificar se um tipo de alerta está habilitado
      function isAlertTypeEnabled(type) {
        if (type === 'system') {
          return alertSettings.systemAlerts;
        } else if (type === 'custom') {
          return alertSettings.customAlerts;
        }
        return false;
      }

      // Função para testar alertas
      function testAlerts() {
        const systemEnabled = alertSettings.systemAlerts;
        const customEnabled = alertSettings.customAlerts;
        
        let message = 'Teste de Alertas:\n\n';
        
        if (systemEnabled && customEnabled) {
          message += '✅ Alertas do Sistema: ATIVO\n✅ Padrões Customizados: ATIVO\n\nAmbos os tipos de alertas serão exibidos.';
          showSuccess('Teste realizado! Ambos os tipos de alertas estão ativos.');
        } else if (systemEnabled && !customEnabled) {
          message += '✅ Alertas do Sistema: ATIVO\n❌ Padrões Customizados: INATIVO\n\nApenas alertas automáticos do sistema serão exibidos.';
          showSuccess('Teste realizado! Apenas alertas do sistema estão ativos.');
        } else if (!systemEnabled && customEnabled) {
          message += '❌ Alertas do Sistema: INATIVO\n✅ Padrões Customizados: ATIVO\n\nApenas padrões customizados serão exibidos.';
          showSuccess('Teste realizado! Apenas padrões customizados estão ativos.');
        } else {
          message += '❌ Alertas do Sistema: INATIVO\n❌ Padrões Customizados: INATIVO\n\n⚠️ ATENÇÃO: Nenhum alerta será exibido!';
          showError('Teste realizado! ATENÇÃO: Todos os alertas estão desabilitados.');
        }
        
        // Mostrar um alerta de teste se pelo menos um tipo estiver ativo
        if (systemEnabled || customEnabled) {
          setTimeout(() => {
            showTestAlert(systemEnabled, customEnabled);
          }, 1500);
        }
      }

      // Mostrar alerta de teste
      function showTestAlert(systemEnabled, customEnabled) {
        const testAlert = document.createElement('div');
        testAlert.className = 'alert alert-info alert-dismissible fade show position-fixed';
        testAlert.style.cssText = 'top: 140px; right: 20px; z-index: 9999; min-width: 350px; max-width: 400px;';
        
        let alertType = '';
        let icon = '';
        
        if (systemEnabled && customEnabled) {
          alertType = 'SISTEMA & CUSTOMIZADO';
          icon = '🤖⚙️';
        } else if (systemEnabled) {
          alertType = 'SISTEMA';
          icon = '🤖';
        } else if (customEnabled) {
          alertType = 'CUSTOMIZADO';
          icon = '⚙️';
        }
        
        testAlert.innerHTML = `
          <div class="d-flex align-items-center">
            <div style="font-size: 24px; margin-right: 10px;">${icon}</div>
            <div>
              <strong>ALERTA DE TESTE - ${alertType}</strong><br>
              <small>Este é um exemplo de como os alertas aparecerão durante o jogo.</small>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(testAlert);

        setTimeout(() => {
          if (testAlert.parentNode) {
            testAlert.parentNode.removeChild(testAlert);
          }
        }, 8000);
      }

      // Função de debug para verificar configurações
      function debugAlertSettings() {
        console.log('=== DEBUG CONFIGURAÇÕES DE ALERTA ===');
        
        // Verificar estado atual
        console.log('Estado atual:', alertSettings);
        
        // Verificar localStorage
        const localData = localStorage.getItem('alertSettings');
        console.log('localStorage:', localData);
        if (localData) {
          try {
            const parsed = JSON.parse(localData);
            console.log('localStorage parseado:', parsed);
          } catch (e) {
            console.error('Erro ao parsear localStorage:', e);
          }
        }
        
        // Verificar checkboxes
        const systemCheck = document.getElementById('enableSystemAlerts');
        const customCheck = document.getElementById('enableCustomAlerts');
        console.log('Checkbox Sistema:', systemCheck.checked);
        console.log('Checkbox Custom:', customCheck.checked);
        
        // Teste de salvamento
        console.log('Testando salvamento...');
        const testSave = {
          systemAlerts: systemCheck.checked,
          customAlerts: customCheck.checked,
          timestamp: new Date().toISOString()
        };
        
        fetch('/api/alert-settings', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(testSave)
        }).then(response => {
          console.log('Resposta do servidor:', response.status);
          return response.json();
        }).then(data => {
          console.log('Dados retornados:', data);
        }).catch(error => {
          console.error('Erro no teste:', error);
        });
        
        // Mostrar no console do navegador
        alert('Debug info enviado para o console (F12)');
      }

      async function loadPatterns() {
        console.log("loadPatterns() chamada");
        showLoading(true);
        try {
          const response = await fetch("/api/custom-patterns");
          console.log("Response status:", response.status);
          const data = await response.json();
          console.log("Data received:", data);

          if (data.success) {
            patterns = data.patterns;
            console.log("Patterns loaded:", patterns.length);
            renderPatterns();
            updateStats();
          } else {
            console.error("API error:", data.error);
            showError("Erro ao carregar padrões: " + data.error);
          }
        } catch (error) {
          console.error("Fetch error:", error);
          showError("Erro ao carregar padrões: " + error.message);
        } finally {
          showLoading(false);
        }
      }

      function renderPatterns() {
        const container = document.getElementById("patternsList");
        const emptyState = document.getElementById("emptyState");

        if (patterns.length === 0) {
          container.innerHTML = "";
          emptyState.style.display = "block";
          return;
        }

        emptyState.style.display = "none";

        container.innerHTML = patterns
          .map(
            (pattern) => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card pattern-card ${
                      pattern.enabled ? "enabled" : "disabled"
                    }">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">${pattern.name}</h6>
                                <div class="action-buttons d-flex">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPattern('${
                                      pattern.pattern_id
                                    }')" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewStats('${
                                      pattern.pattern_id
                                    }')" title="Estatísticas">
                                        <i class="fas fa-chart-bar"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePattern('${
                                      pattern.pattern_id
                                    }')" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <p class="card-text text-muted small">${
                              pattern.description || "Sem descrição"
                            }</p>
                            
                            <div class="mb-2">
                                <span class="badge trigger-badge bg-primary">${getTriggerTypeLabel(
                                  pattern.trigger_type
                                )}</span>
                                <span class="badge trigger-badge bg-secondary">${getActionTypeLabel(
                                  pattern.action
                                )}</span>
                            </div>
                            
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Sucessos</small>
                                    <div class="stats-badge badge bg-success">${
                                      pattern.success_count
                                    }</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Falhas</small>
                                    <div class="stats-badge badge bg-danger">${
                                      pattern.failure_count
                                    }</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Taxa</small>
                                    <div class="stats-badge badge ${getSuccessRateClass(
                                      pattern.success_count,
                                      pattern.failure_count
                                    )}">
                                        ${getSuccessRate(
                                          pattern.success_count,
                                          pattern.failure_count
                                        )}%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> 
                                    ${
                                      pattern.last_triggered
                                        ? new Date(
                                            pattern.last_triggered
                                          ).toLocaleString()
                                        : "Nunca"
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function updateStats() {
        const total = patterns.length;
        const active = patterns.filter((p) => p.enabled).length;
        const totalTriggers = patterns.reduce(
          (sum, p) => sum + p.success_count + p.failure_count,
          0
        );
        const totalSuccesses = patterns.reduce(
          (sum, p) => sum + p.success_count,
          0
        );
        const successRate =
          totalTriggers > 0
            ? Math.round((totalSuccesses / totalTriggers) * 100)
            : 0;

        document.getElementById("totalPatterns").textContent = total;
        document.getElementById("activePatterns").textContent = active;
        document.getElementById("totalTriggers").textContent = totalTriggers;
        document.getElementById("successRate").textContent = successRate + "%";
      }

      function getTriggerTypeLabel(type) {
        const labels = {
          number_followed_by_color: "Nº→Cor",
          color_sequence: "Seq.Cores",
          number_sequence: "Seq.Números",
          color_after_color: "Cor→Cor",
          number_after_number: "Nº→Nº",
          specific_number_red: "Nº Red",
          specific_number_black: "Nº Black",
          specific_number_white: "Nº White",
          red_after_black: "Red→Black",
          black_after_red: "Black→Red",
          white_after_any: "White→Qualquer",
          number_delay_alert: "Nº+Delay",
        };
        return labels[type] || type;
      }

      function getActionTypeLabel(action) {
        const labels = {
          bet_color: "Apostar Cor",
          bet_number: "Apostar Nº",
          bet_sector: "Apostar Setor",
          skip_bet: "Pular",
          wait: "Aguardar",
        };
        return labels[action] || action;
      }

      function getSuccessRate(successes, failures) {
        const total = successes + failures;
        return total > 0 ? Math.round((successes / total) * 100) : 0;
      }

      function getSuccessRateClass(successes, failures) {
        const rate = getSuccessRate(successes, failures);
        if (rate >= 70) return "bg-success";
        if (rate >= 50) return "bg-warning";
        return "bg-danger";
      }

      function updateTriggerConfig() {
        const triggerType = document.getElementById("triggerType").value;
        const configArea = document.getElementById("triggerConfigArea");
        const helpElement = document.getElementById("triggerTypeHelp");

        // Update help text based on selection
        if (triggerType) {
          const selectedOption = document.querySelector(`#triggerType option[value="${triggerType}"]`);
          if (selectedOption) {
            const description = selectedOption.getAttribute('data-description') || '';
            const example = selectedOption.getAttribute('data-example') || '';
            helpElement.innerHTML = `
              <i class="fas fa-info-circle text-primary"></i> 
              <strong>${description}</strong><br>
              <small class="text-success">${example}</small>
            `;
          }
        } else {
          helpElement.innerHTML = `
            <i class="fas fa-arrow-up"></i> Selecione um tipo para ver a explicação e exemplo
          `;
        }

        if (!triggerType) {
          configArea.style.display = "none";
          updateConfigPreview();
          return;
        }

        configArea.style.display = "block";

        let configHTML = "";

        switch (triggerType) {
          case "number_followed_by_color":
            configHTML = `
                        <div class="alert alert-info">
                          <i class="fas fa-info-circle"></i> 
                          <strong>Configure:</strong> Escolha um número e a cor que deve vir após ele.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Número (0-14)</label>
                                <input type="number" class="form-control" id="triggerNumber" min="0" max="14" value="1">
                                <small class="text-muted">Qualquer número da roleta</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cor que deve seguir</label>
                                <select class="form-select" id="triggerColor">
                                    <option value="red">🔴 Vermelho</option>
                                    <option value="black">⚫ Preto</option>
                                    <option value="white">⚪ Branco</option>
                                </select>
                                <small class="text-muted">Cor que deve aparecer após o número</small>
                            </div>
                        </div>
                    `;
            break;

          case "color_sequence":
            configHTML = `
                        <div class="alert alert-info">
                          <i class="fas fa-info-circle"></i> 
                          <strong>Configure:</strong> Defina uma sequência de 2 cores que devem aparecer consecutivamente.
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Sequência de Cores</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select" id="sequenceColor1">
                                        <option value="red">🔴 Vermelho</option>
                                        <option value="black">⚫ Preto</option>
                                        <option value="white">⚪ Branco</option>
                                    </select>
                                    <i class="fas fa-arrow-right text-primary"></i>
                                    <select class="form-select" id="sequenceColor2">
                                        <option value="red">🔴 Vermelho</option>
                                        <option value="black">⚫ Preto</option>
                                        <option value="white">⚪ Branco</option>
                                    </select>
                                </div>
                                <small class="text-muted">Ex: Vermelho seguido de Preto</small>
                            </div>
                        </div>
                    `;
            break;

          case "color_after_color":
            configHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Primeira Cor</label>
                                <select class="form-select" id="firstColor">
                                    <option value="red">Vermelho</option>
                                    <option value="black">Preto</option>
                                    <option value="white">Branco</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Segunda Cor</label>
                                <select class="form-select" id="secondColor">
                                    <option value="red">Vermelho</option>
                                    <option value="black">Preto</option>
                                    <option value="white">Branco</option>
                                </select>
                            </div>
                        </div>
                    `;
            break;

          case "specific_number_red":
            configHTML = `
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Número Red (1, 3, 5, 7, 9, 12, 14)</label>
                                <select class="form-select" id="redNumber">
                                    <option value="1">1 (Red)</option>
                                    <option value="3">3 (Red)</option>
                                    <option value="5">5 (Red)</option>
                                    <option value="7">7 (Red)</option>
                                    <option value="9">9 (Red)</option>
                                    <option value="12">12 (Red)</option>
                                    <option value="14">14 (Red)</option>
                                </select>
                            </div>
                        </div>
                    `;
            break;

          case "specific_number_black":
            configHTML = `
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Número Black (2, 4, 6, 8, 10, 11, 13)</label>
                                <select class="form-select" id="blackNumber">
                                    <option value="2">2 (Black)</option>
                                    <option value="4">4 (Black)</option>
                                    <option value="6">6 (Black)</option>
                                    <option value="8">8 (Black)</option>
                                    <option value="10">10 (Black)</option>
                                    <option value="11">11 (Black)</option>
                                    <option value="13">13 (Black)</option>
                                </select>
                            </div>
                        </div>
                    `;
            break;

          case "specific_number_white":
            configHTML = `
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Número White (0)</label>
                                <select class="form-select" id="whiteNumber">
                                    <option value="0">0 (White)</option>
                                </select>
                            </div>
                        </div>
                    `;
            break;

          case "red_after_black":
            configHTML = `
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Red Após Black</label>
                                <small class="form-text text-muted">Detecta quando red aparece após black</small>
                            </div>
                        </div>
                    `;
            break;

          case "black_after_red":
            configHTML = `
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">Black Após Red</label>
                                <small class="form-text text-muted">Detecta quando black aparece após red</small>
                            </div>
                        </div>
                    `;
            break;

          case "white_after_any":
            configHTML = `
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">White Após Qualquer Cor</label>
                                <small class="form-text text-muted">Detecta quando white (0) aparece após qualquer cor</small>
                            </div>
                        </div>
                    `;
            break;
          case "number_delay_alert":
            configHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Número que Ativa</label>
                                <input type="number" class="form-control" id="triggerNumberDelay" min="0" max="14" value="5">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Delay (resultados)</label>
                                <input type="number" class="form-control" id="delayResults" min="1" max="20" value="5">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <small class="form-text text-muted">
                                    <strong>Exemplo:</strong> Quando sair o número 5, aguardar 5 resultados e então alertar
                                </small>
                            </div>
                        </div>
                    `;
            break;
        }

        configArea.innerHTML = configHTML;
        updateConfigPreview();
      }

      function updateActionConfig() {
        const actionType = document.getElementById("actionType").value;
        const configArea = document.getElementById("actionConfigArea");
        const helpElement = document.getElementById("actionTypeHelp");

        // Update help text based on selection
        if (actionType) {
          const selectedOption = document.querySelector(`#actionType option[value="${actionType}"]`);
          if (selectedOption) {
            const description = selectedOption.getAttribute('data-description') || '';
            const example = selectedOption.getAttribute('data-example') || '';
            helpElement.innerHTML = `
              <i class="fas fa-info-circle text-success"></i> 
              <strong>${description}</strong><br>
              <small class="text-primary">${example}</small>
            `;
          }
        } else {
          helpElement.innerHTML = `
            <i class="fas fa-arrow-up"></i> Selecione uma ação para ver a explicação e exemplo
          `;
        }

        let configHTML = "";

        switch (actionType) {
          case "bet_color":
            configHTML = `
                        <div class="alert alert-success">
                          <i class="fas fa-info-circle"></i> 
                          <strong>Apostar em Cor:</strong> Escolha a cor que será recomendada quando o padrão for detectado.
                        </div>
                        <label class="form-label">Cor para apostar</label>
                        <select class="form-select" id="actionColor">
                            <option value="red">🔴 Vermelho (14x retorno)</option>
                            <option value="black">⚫ Preto (2x retorno)</option>
                            <option value="white">⚪ Branco (14x retorno)</option>
                        </select>
                        <small class="text-muted">A cor que será recomendada no alerta</small>
                    `;
            break;

          case "bet_number":
            configHTML = `
                        <div class="alert alert-success">
                          <i class="fas fa-info-circle"></i> 
                          <strong>Apostar em Número:</strong> Escolha o número específico que será recomendado.
                        </div>
                        <label class="form-label">Número para apostar (0-14)</label>
                        <input type="number" class="form-control" id="actionNumber" min="0" max="14" value="1">
                        <small class="text-muted">Número específico que será recomendado (retorno: 14x)</small>
                    `;
            break;

          case "skip_bet":
            configHTML = `
                        <div class="alert alert-warning">
                          <i class="fas fa-pause-circle"></i> 
                          <strong>Pular Aposta:</strong> O sistema recomendará não apostar nesta rodada.
                        </div>
                        <div class="text-center p-3 bg-light rounded">
                          <i class="fas fa-hand-paper fa-2x text-warning mb-2"></i>
                          <p class="mb-0"><strong>Nenhuma configuração adicional necessária</strong></p>
                          <small class="text-muted">O alerta será: "Pule esta rodada - aguarde melhor oportunidade"</small>
                        </div>
                    `;
            break;

          case "wait":
            configHTML = `
                        <div class="alert alert-info">
                          <i class="fas fa-clock"></i> 
                          <strong>Aguardar:</strong> O sistema recomendará observar mais resultados antes de apostar.
                        </div>
                        <div class="text-center p-3 bg-light rounded">
                          <i class="fas fa-hourglass-half fa-2x text-info mb-2"></i>
                          <p class="mb-0"><strong>Nenhuma configuração adicional necessária</strong></p>
                          <small class="text-muted">O alerta será: "Aguarde - padrão ainda se formando"</small>
                        </div>
                    `;
            break;

          default:
            configHTML = `
                        <div class="text-center p-3 bg-light rounded">
                          <i class="fas fa-arrow-up fa-2x text-muted mb-2"></i>
                          <p class="text-muted mb-0">Selecione um tipo de ação acima</p>
                        </div>
                    `;
        }

        configArea.innerHTML = configHTML;
        updateConfigPreview();
      }

      function updateConfigPreview() {
        const triggerType = document.getElementById("triggerType").value;
        const actionType = document.getElementById("actionType").value;
        const preview = document.getElementById("configPreview");

        if (!triggerType || !actionType) {
          preview.textContent =
            "Selecione um tipo de gatilho e ação para ver a pré-visualização";
          return;
        }

        let triggerDesc = "";
        let actionDesc = "";

        // Trigger description
        switch (triggerType) {
          case "number_followed_by_color":
            const number =
              document.getElementById("triggerNumber")?.value || "1";
            const color =
              document.getElementById("triggerColor")?.value || "red";
            triggerDesc = `Quando o número ${number} for seguido por ${color}`;
            break;
          case "color_sequence":
            const color1 =
              document.getElementById("sequenceColor1")?.value || "red";
            const color2 =
              document.getElementById("sequenceColor2")?.value || "black";
            triggerDesc = `Quando aparecer a sequência ${color1} → ${color2}`;
            break;
          case "color_after_color":
            const firstColor =
              document.getElementById("firstColor")?.value || "red";
            const secondColor =
              document.getElementById("secondColor")?.value || "black";
            triggerDesc = `Quando ${firstColor} for seguido por ${secondColor}`;
            break;
          case "specific_number_red":
            const redNumber =
              document.getElementById("redNumber")?.value || "1";
            triggerDesc = `Quando o número ${redNumber} (red) aparecer`;
            break;
          case "specific_number_black":
            const blackNumber =
              document.getElementById("blackNumber")?.value || "2";
            triggerDesc = `Quando o número ${blackNumber} (black) aparecer`;
            break;
          case "specific_number_white":
            triggerDesc = `Quando o número 0 (white) aparecer`;
            break;
          case "red_after_black":
            triggerDesc = `Quando red aparecer após black`;
            break;
          case "black_after_red":
            triggerDesc = `Quando black aparecer após red`;
            break;
          case "white_after_any":
            triggerDesc = `Quando white (0) aparecer após qualquer cor`;
            break;
          case "number_delay_alert":
            const triggerNumberDelay =
              document.getElementById("triggerNumberDelay")?.value || "5";
            const delayResults =
              document.getElementById("delayResults")?.value || "5";
            triggerDesc = `Quando sair o número ${triggerNumberDelay}, aguardar ${delayResults} resultados e alertar`;
            break;
        }

        // Action description
        switch (actionType) {
          case "bet_color":
            const actionColor =
              document.getElementById("actionColor")?.value || "red";
            actionDesc = `Apostar na cor ${actionColor}`;
            break;
          case "bet_number":
            const actionNumber =
              document.getElementById("actionNumber")?.value || "1";
            actionDesc = `Apostar no número ${actionNumber}`;
            break;
          case "skip_bet":
            actionDesc = "Pular esta rodada";
            break;
          case "wait":
            actionDesc = "Aguardar próxima oportunidade";
            break;
        }

        preview.innerHTML = `
                <strong>Gatilho:</strong> ${triggerDesc}<br>
                <strong>Ação:</strong> ${actionDesc}
            `;
      }

      function updateConfidenceValue() {
        const slider = document.getElementById("confidenceThreshold");
        const value = document.getElementById("confidenceValue");
        value.textContent = Math.round(slider.value * 100) + "%";
        updateConfigPreview();
      }

      async function savePattern() {
        const form = document.getElementById("patternForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const triggerType = document.getElementById("triggerType").value;
        const actionType = document.getElementById("actionType").value;

        if (!triggerType || !actionType) {
          showError("Selecione um tipo de gatilho e ação");
          return;
        }

        // Build trigger config
        let triggerConfig = {};
        switch (triggerType) {
          case "number_followed_by_color":
            triggerConfig = {
              number: parseInt(document.getElementById("triggerNumber").value),
              color: document.getElementById("triggerColor").value,
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "color_sequence":
            triggerConfig = {
              sequence: [
                document.getElementById("sequenceColor1").value,
                document.getElementById("sequenceColor2").value,
              ],
              min_length: 2,
            };
            break;
          case "color_after_color":
            triggerConfig = {
              first_color: document.getElementById("firstColor").value,
              second_color: document.getElementById("secondColor").value,
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "specific_number_red":
            triggerConfig = {
              number: parseInt(document.getElementById("redNumber").value),
              color: "red",
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "specific_number_black":
            triggerConfig = {
              number: parseInt(document.getElementById("blackNumber").value),
              color: "black",
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "specific_number_white":
            triggerConfig = {
              number: 0,
              color: "white",
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "red_after_black":
            triggerConfig = {
              first_color: "black",
              second_color: "red",
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "black_after_red":
            triggerConfig = {
              first_color: "red",
              second_color: "black",
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "white_after_any":
            triggerConfig = {
              number: 0,
              color: "white",
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
          case "number_delay_alert":
            triggerConfig = {
              trigger_number: parseInt(
                document.getElementById("triggerNumberDelay").value
              ),
              delay_results: parseInt(
                document.getElementById("delayResults").value
              ),
              min_occurrences: parseInt(
                document.getElementById("minOccurrences").value
              ),
            };
            break;
        }

        // Build action config
        let actionConfig = {};
        switch (actionType) {
          case "bet_color":
            actionConfig = {
              color: document.getElementById("actionColor").value,
            };
            break;
          case "bet_number":
            actionConfig = {
              number: parseInt(document.getElementById("actionNumber").value),
            };
            break;
        }

        const patternData = {
          name: document.getElementById("patternName").value,
          description: document.getElementById("patternDescription").value,
          trigger_type: triggerType,
          trigger_config: triggerConfig,
          action: actionType,
          action_config: actionConfig,
          confidence_threshold: parseFloat(
            document.getElementById("confidenceThreshold").value
          ),
          cooldown_minutes: parseInt(
            document.getElementById("cooldownMinutes").value
          ),
          enabled: document.getElementById("patternEnabled").value === "true",
        };

        try {
          let response;
          if (editingPattern) {
            response = await fetch(`/api/custom-patterns/${editingPattern}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(patternData),
            });
          } else {
            response = await fetch("/api/custom-patterns", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(patternData),
            });
          }

          const result = await response.json();

          if (result.success) {
            showSuccess(result.message);
            bootstrap.Modal.getInstance(
              document.getElementById("createPatternModal")
            ).hide();
            loadPatterns();
            resetForm();
          } else {
            showError("Erro ao salvar padrão: " + result.error);
          }
        } catch (error) {
          showError("Erro ao salvar padrão: " + error.message);
        }
      }

      function editPattern(patternId) {
        const pattern = patterns.find((p) => p.pattern_id === patternId);
        if (!pattern) return;

        editingPattern = patternId;
        document.getElementById("modalTitle").textContent = "Editar Padrão";

        // Fill form
        document.getElementById("patternName").value = pattern.name;
        document.getElementById("patternDescription").value =
          pattern.description;
        document.getElementById("triggerType").value = pattern.trigger_type;
        document.getElementById("actionType").value = pattern.action;
        document.getElementById("confidenceThreshold").value =
          pattern.confidence_threshold;
        document.getElementById("cooldownMinutes").value =
          pattern.cooldown_minutes;
        document.getElementById("patternEnabled").value =
          pattern.enabled.toString();

        updateTriggerConfig();
        updateActionConfig();
        updateConfidenceValue();

        // Fill trigger config
        if (pattern.trigger_config) {
          Object.keys(pattern.trigger_config).forEach((key) => {
            const element = document.getElementById(key.replace("_", ""));
            if (element) {
              element.value = pattern.trigger_config[key];
            }
          });
        }

        // Fill action config
        if (pattern.action_config) {
          Object.keys(pattern.action_config).forEach((key) => {
            const element = document.getElementById(
              "action" + key.charAt(0).toUpperCase() + key.slice(1)
            );
            if (element) {
              element.value = pattern.action_config[key];
            }
          });
        }

        updateConfigPreview();

        new bootstrap.Modal(
          document.getElementById("createPatternModal")
        ).show();
      }

      async function deletePattern(patternId) {
        if (!confirm("Tem certeza que deseja excluir este padrão?")) {
          return;
        }

        try {
          const response = await fetch(`/api/custom-patterns/${patternId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showSuccess("Padrão excluído com sucesso");
            loadPatterns();
          } else {
            showError("Erro ao excluir padrão: " + result.error);
          }
        } catch (error) {
          showError("Erro ao excluir padrão: " + error.message);
        }
      }

      async function viewStats(patternId) {
        try {
          const response = await fetch(
            `/api/custom-patterns/${patternId}/stats`
          );
          const result = await response.json();

          if (result.success) {
            const stats = result.stats;
            document.getElementById("statsContent").innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-success">${
                                  stats.success_count
                                }</h4>
                                <small class="text-muted">Sucessos</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-danger">${
                                  stats.failure_count
                                }</h4>
                                <small class="text-muted">Falhas</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-primary">${
                                  stats.total_triggers
                                }</h4>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <h3 class="text-info">${Math.round(
                              stats.success_rate * 100
                            )}%</h3>
                            <small class="text-muted">Taxa de Sucesso</small>
                        </div>
                        <hr>
                        <div class="text-center">
                            <small class="text-muted">
                                <strong>Último Trigger:</strong><br>
                                ${
                                  stats.last_triggered
                                    ? new Date(
                                        stats.last_triggered
                                      ).toLocaleString()
                                    : "Nunca"
                                }
                            </small>
                        </div>
                    `;

            new bootstrap.Modal(document.getElementById("statsModal")).show();
          } else {
            showError("Erro ao carregar estatísticas: " + result.error);
          }
        } catch (error) {
          showError("Erro ao carregar estatísticas: " + error.message);
        }
      }

      async function exportPatterns() {
        try {
          const response = await fetch("/api/custom-patterns/export");
          const result = await response.json();

          if (result.success) {
            showSuccess("Padrões exportados com sucesso");
          } else {
            showError("Erro ao exportar padrões: " + result.error);
          }
        } catch (error) {
          showError("Erro ao exportar padrões: " + error.message);
        }
      }

      async function importPatterns(input) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/api/custom-patterns/import", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showSuccess("Padrões importados com sucesso");
            loadPatterns();
          } else {
            showError("Erro ao importar padrões: " + result.error);
          }
        } catch (error) {
          showError("Erro ao importar padrões: " + error.message);
        }

        input.value = "";
      }

      function resetForm() {
        editingPattern = null;
        document.getElementById("patternForm").reset();
        document.getElementById("modalTitle").textContent = "Criar Novo Padrão";
        document.getElementById("triggerConfigArea").style.display = "none";
        document.getElementById("actionConfigArea").innerHTML = "";
        document.getElementById("configPreview").textContent =
          "Selecione um tipo de gatilho para ver a pré-visualização";
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showSuccess(message) {
        // Simple success notification
        const alert = document.createElement("div");
        alert.className =
          "alert alert-success alert-dismissible fade show position-fixed";
        alert.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        document.body.appendChild(alert);

        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 5000);
      }

      function showError(message) {
        // Simple error notification
        const alert = document.createElement("div");
        alert.className =
          "alert alert-danger alert-dismissible fade show position-fixed";
        alert.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        document.body.appendChild(alert);

        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 5000);
      }

      // Event listeners
      document
        .getElementById("triggerType")
        .addEventListener("change", updateTriggerConfig);
      document
        .getElementById("actionType")
        .addEventListener("change", updateActionConfig);
      document
        .getElementById("confidenceThreshold")
        .addEventListener("input", updateConfidenceValue);

      // Reset form when modal is hidden
      document
        .getElementById("createPatternModal")
        .addEventListener("hidden.bs.modal", resetForm);

      // Initialize tooltips
      document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });

      // Add event listener for trigger type selection to show contextual help
      document.getElementById("triggerType").addEventListener("change", function() {
        const value = this.value;
        const helpElement = document.getElementById("triggerTypeHelp");
        
        if (value) {
          const option = this.querySelector(`option[value="${value}"]`);
          const description = option.getAttribute('data-description') || '';
          const example = option.getAttribute('data-example') || '';
          
          helpElement.innerHTML = `
            <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
              <i class="fas fa-info-circle text-primary"></i> 
              <strong>${description}</strong><br>
              <small class="text-success"><i class="fas fa-lightbulb"></i> ${example}</small>
            </div>
          `;
        }
        
        updateTriggerConfig();
      });

      // Add event listener for action type selection to show contextual help  
      document.getElementById("actionType").addEventListener("change", function() {
        const value = this.value;
        const helpElement = document.getElementById("actionTypeHelp");
        
        if (value) {
          const option = this.querySelector(`option[value="${value}"]`);
          const description = option.getAttribute('data-description') || '';
          const example = option.getAttribute('data-example') || '';
          
          helpElement.innerHTML = `
            <div class="mt-2 p-2 bg-success bg-opacity-10 rounded">
              <i class="fas fa-info-circle text-success"></i> 
              <strong>${description}</strong><br>
              <small class="text-primary"><i class="fas fa-lightbulb"></i> ${example}</small>
            </div>
          `;
        }
        
        updateActionConfig();
      });
    </script>
  </body>
</html>
